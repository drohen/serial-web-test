function j(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function H(r,e,t){return t={path:e,exports:{},require:function(i,s){return D(i,s??t.path)}},r(t,t.exports),t.exports}function D(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var P=H(function(r,e){Object.defineProperty(e,"__esModule",{value:!0});var t;(function(s){s.typeOfFunction="function",s.boolTrue=!0})(t||(t={}));function i(s,o,n){if(!n||typeof n.value!==t.typeOfFunction)throw new TypeError("Only methods can be decorated with @bind. <"+o+"> is not a method!");return{configurable:t.boolTrue,get:function(){var a=n.value.bind(this);return Object.defineProperty(this,o,{value:a,configurable:t.boolTrue,writable:t.boolTrue}),a}}}e.bind=i,e.default=i}),C=j(P),h=C;var L=Object.defineProperty,A=Object.getOwnPropertyDescriptor,g=(r,e,t,i)=>{for(var s=i>1?void 0:i?A(e,t):e,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&L(e,t,s),s},b=class{constructor(e,t,i,s,o=2048){this.actx=e,this.src=t,this.cvs=i,this.dest=s,this.FFT=o,this.DEFAULT_FILL="#111111",this.DEFAULT_STROKE="#11ff11",this.HLINE_COLOR="#555555",this.paused=!1,this.anl=this.actx.createAnalyser(),this.anl.fftSize=this.FFT,this.src.connect(this.anl),this.dest&&this.anl.connect(this.dest);let{width:n=300,height:a=150}=this.cvs;this.WIDTH=n,this.HEIGHT=a,this.u8ar=new Uint8Array(this.FFT);let u=this.cvs.getContext("2d");if(!u)throw"No rendering context";this.cctx=u,this.initCVS(this.cctx)}initCVS(e){e.fillStyle=this.DEFAULT_FILL,e.strokeStyle=this.DEFAULT_STROKE}primer(e,t,i){e.fillRect(0,0,t,i),e.strokeStyle=this.HLINE_COLOR,e.beginPath(),e.moveTo(0,i/2),e.lineTo(t,i/2),e.stroke(),e.strokeStyle=this.DEFAULT_STROKE}drawRawOsc(e,t,i,s){e.beginPath();for(let o=0;o<t.length;o++){let n=o*(i*1/t.length),u=t[o]/128*s/2;o===0?e.moveTo(n,u):e.lineTo(n,u)}e.stroke()}draw(){this.paused||requestAnimationFrame(this.draw),this.cctx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.primer(this.cctx,this.WIDTH,this.HEIGHT),this.anl.getByteTimeDomainData(this.u8ar),this.drawRawOsc(this.cctx,this.u8ar,this.WIDTH,this.HEIGHT)}start(){this.paused=!1,this.draw()}pause(){this.paused=!0}reset(){this.paused=!0,requestAnimationFrame(()=>{this.u8ar=new Uint8Array(this.FFT).fill(0),this.cctx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.primer(this.cctx,this.WIDTH,this.HEIGHT),this.drawRawOsc(this.cctx,this.u8ar,this.WIDTH,this.HEIGHT)})}};g([h],b.prototype,"draw",1);g([h],b.prototype,"start",1);g([h],b.prototype,"pause",1);g([h],b.prototype,"reset",1);var F=Object.defineProperty,I=Object.getOwnPropertyDescriptor,O=(r,e,t,i)=>{for(var s=i>1?void 0:i?I(e,t):e,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&F(e,t,s),s},f=class{constructor(){this.osc=[],this.gain=[],this.scopes=[]}setupAudio(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gain.push(this.audioContext.createGain()),this.gain[0].connect(this.audioContext.destination)}createOsc(e,t="sine",i=50){let s=e.createOscillator();return s.type=t,s.frequency.setValueAtTime(i,e.currentTime),s.connect(this.gain[0]),s.start(),s}next({index:e,value:t}){if(!this.audioContext||!this.osc[e])return;let i=~~(t*990+10);if(Math.abs(i-this.osc[e].frequency.value)<3)return;let s=this.audioContext.currentTime+1e-4;this.osc[e].frequency.linearRampToValueAtTime(i,s)}stop(){this.audioContext?.suspend().then(()=>this.audioContext?.close())}setOscilloscope({canvas:e,index:t}){if(!this.audioContext||this.scopes.find(o=>o.index===t))return;if(t>-1){this.osc[t]=this.createOsc(this.audioContext,t?"sawtooth":"square");let o=this.osc.length>0?1/this.osc.length:1;this.gain[0].gain.setValueAtTime(o,this.audioContext.currentTime)}let i=t===-1?this.gain[0]:this.osc[t],s=new b(this.audioContext,i,e,void 0,256);s.start(),this.scopes.push({index:t,scope:s})}};O([h],f.prototype,"setupAudio",1);O([h],f.prototype,"next",1);O([h],f.prototype,"stop",1);function p(r,e){let t=(e??document).querySelector(r);if(!t)throw Error(`No element ${r}`);return t}function T(r){return{do:e=>{if(r!=null)return e(r)}}}function x(r){return{on:e=>({do:t=>(r.addEventListener(e,t),()=>r.removeEventListener(e,t))})}}var R=Object.defineProperty,q=Object.getOwnPropertyDescriptor,_=(r,e,t,i)=>{for(var s=i>1?void 0:i?q(e,t):e,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&R(e,t,s),s},d=class{constructor(){this.genericLUT={error:e=>this.error(e),warn:e=>this.warn(e),info:e=>this.info(e)}}error(e){console.error(e)}warn(e){console.warn(e)}info(e){console.info(e)}next(e){this.genericLUT[e.level](e.message)}};_([h],d.prototype,"error",1);_([h],d.prototype,"warn",1);_([h],d.prototype,"info",1);var l=class{next(e){this.subscriber?.next?.(e)}completed(){this.subscriber?.completed?.()}subscribe(e){this.subscriber=e}};var c;(function(r){r.error="error",r.warn="warn",r.info="info"})(c||(c={}));var m=class{constructor(){this.logObservable=new l}log(e,t){this.logObservable.next({level:e,message:t})}};var U=Object.defineProperty,G=Object.getOwnPropertyDescriptor,N=(r,e,t,i)=>{for(var s=i>1?void 0:i?G(e,t):e,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&U(e,t,s),s},w=class{constructor(){this.curr=[],this.debounce=[],this.inputObservable=new l,this.emitObservable=new l,this.log=new m,this.logObservable=this.log.logObservable}setupSerial(){navigator.serial.requestPort().then(e=>(this.port=e,this.emitObservable.next(),this.readPort())).catch(e=>{this.log.log(c.warn,e)})}async readPort(){if(!this.port){this.log.log(c.warn,"No port available");return}if(await this.port.open({baudRate:115200}),this.log.log(c.info,"Serial connected"),this.port.readable){let e=this.port.readable.getReader(),t=!0;try{for(;t;)if(!this.handleSerial(await e.read())){t=!1;break}}catch(i){this.log.log(c.error,i.message)}finally{this.log.log(c.warn,"Serial exiting"),e.releaseLock(),this.emitObservable.completed()}}}handleSerial({value:e,done:t}){if(t)return!1;let i=5;if(e&&e[0]===192&&e.length>=i){let s=2,o=100;for(let n=1;n<i;n+=s){let a=(n-1)/2,u=e[n+1]|e[n]<<8;this.debounce[a]===void 0&&(this.debounce[a]=0),this.curr[a]===void 0&&(this.curr[a]=0),Math.abs(u-this.curr[a])>o?(this.curr[a]=u,this.inputObservable.next({index:a,value:this.curr[a]/65535}),this.debounce[a]=0):this.debounce[a]>10?(this.inputObservable.next({index:a,value:this.curr[a]/65535}),this.debounce[a]=0):this.debounce[a]=this.debounce[a]+1}}else this.log.log(c.warn,`Received ${e}`);return!0}};N([h],w.prototype,"setupSerial",1);var W=Object.defineProperty,V=Object.getOwnPropertyDescriptor,E=(r,e,t,i)=>{for(var s=i>1?void 0:i?V(e,t):e,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&W(e,t,s),s},v=class extends HTMLElement{constructor(e){super();this.tag=e,this.isDefined=!1,this.stylesheets=[];let i=p(`#${e}`).content;this.attachShadow({mode:"open"}).appendChild(i.cloneNode(!0)),this.registerStylesheet("main.css"),customElements.whenDefined(this.tag).then(()=>{this.isDefined=!0;for(let s of this.stylesheets)this.setStylesheet(s);this.onDefined()})}setStylesheet(e){let t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("href",e),this.shadowRoot?.appendChild(t)}registerStylesheet(e){this.isDefined?this.setStylesheet(e):this.stylesheets.push(e)}onDefined(){}};E([h],v.prototype,"setStylesheet",1);E([h],v.prototype,"registerStylesheet",1);var S=class extends v{constructor(){super("main-view");this.oscEl=[],this.log=new m,this.logObservable=this.log.logObservable,this.emitObservable=new l,this.canvasObservable=new l,T(this.shadowRoot).do(e=>this.setElements(e))}setElements(e){this.mainOsc=p("#main-osc",e),this.subOsc=p("#osc",e),this.init=p("button",e),navigator.serial||(this.init.remove(),this.mainOsc.innerText="(;¬_¬)  --  looks like you need a different browser to use this application."),x(this.init).on("click").do(()=>{this.log.log(c.info,"Requesting"),this.emitObservable.next()})}canvas(){return document.createElement("canvas")}next({index:e,value:t}){if(this.oscEl.length===0){let i=this.canvas();this.mainOsc?.appendChild(i),this.canvasObservable.next({canvas:i,index:-1})}if(!this.oscEl[e]){let i=document.createElement("p");this.oscEl[e]=i;let s=this.canvas(),o=document.createElement("div");o.className="scope-block",o.append(i,s),this.subOsc?.append(o),this.canvasObservable.next({canvas:s,index:e})}this.oscEl[e].textContent=`Frequency [${e}]: ${~~(t*990+10)}`}onDefined(){this.log.log(c.info,"Loaded main view")}};var y=class{static run(){new y}constructor(){this.logSystem=new d,this.audioSystem=new f,this.serialSystem=new w,this.setupUI(),this.setupSerial()}setupUI(){customElements.define("main-view",S),this.view=p("main-view"),this.view.emitObservable.subscribe({next:this.serialSystem.setupSerial}),this.view.canvasObservable.subscribe({next:e=>void this.audioSystem.setOscilloscope(e)}),this.view.logObservable.subscribe(this.logSystem)}setupSerial(){this.serialSystem.emitObservable.subscribe({next:()=>void this.audioSystem.setupAudio(),completed:this.audioSystem.stop}),this.serialSystem.inputObservable.subscribe({next:e=>{this.audioSystem.next(e),this.view?.next(e)}}),this.serialSystem.logObservable.subscribe(this.logSystem)}};y.run();
